<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Workflow Engine Visualizer & Comprehensive Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .api-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
            border-bottom: 3px solid #3498db;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-icon {
            font-size: 1.2em;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
        }

        input, textarea, select, button {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: #f8fbff;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-warning:hover {
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .workflow-visual {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .workflow-graph {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .state-node {
            background: white;
            border: 3px solid #3498db;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .state-node.initial {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6 0%, #c8e6c9 100%);
            color: #1b5e20;
        }

        .state-node.final {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #d63031;
        }

        .state-node.current {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }

        .action-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
        }

        .arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 20px solid #3498db;
            margin-bottom: 5px;
        }

        .action-label {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .response-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .response-area.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .response-area.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-radius: 0;
            text-transform: none;
            letter-spacing: normal;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .instance-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .instance-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .instance-item:hover {
            background: #f8f9fa;
        }

        .instance-item.selected {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .instance-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .instance-id {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .instance-state {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .instance-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            border-radius: 4px;
            width: auto;
        }

        .history-timeline {
            max-height: 250px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .history-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3498db;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
        }

        .history-action {
            font-weight: 600;
            color: #2c3e50;
        }

        .history-time {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .highlight {
            background: rgba(255, 255, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .workflow-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .panel {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Enhanced Workflow Engine</h1>
            <p>Comprehensive Visualizer & Testing Suite for .NET Workflow Engine</p>
            <div id="apiStatus" class="api-status disconnected">
                <div class="status-dot"></div>
                <span>Checking API Connection...</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Workflow Designer Panel -->
            <div class="panel">
                <h2><span class="panel-icon">🎨</span>Workflow Designer</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('create-tab')">Create</button>
                    <button class="tab" onclick="showTab('templates-tab')">Templates</button>
                    <button class="tab" onclick="showTab('import-tab')">Import/Export</button>
                </div>

                <div id="create-tab" class="tab-content active">
                    <div class="form-section">
                        <h3>Workflow Definition</h3>
                        <div class="form-group">
                            <label for="workflowId">Workflow ID</label>
                            <input type="text" id="workflowId" placeholder="e.g., order-processing" value="demo-workflow">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>States Configuration</h3>
                        <div class="form-group">
                            <label for="statesJson">States (JSON)</label>
                            <textarea id="statesJson" rows="6" placeholder="Define workflow states...">
[
  {"id": "draft", "isInitial": true, "isFinal": false},
  {"id": "review", "isInitial": false, "isFinal": false},
  {"id": "approved", "isInitial": false, "isFinal": true},
  {"id": "rejected", "isInitial": false, "isFinal": true}
]</textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Actions Configuration</h3>
                        <div class="form-group">
                            <label for="actionsJson">Actions (JSON)</label>
                            <textarea id="actionsJson" rows="6" placeholder="Define workflow actions...">
[
  {"id": "submit", "fromStates": ["draft"], "toState": "review"},
  {"id": "approve", "fromStates": ["review"], "toState": "approved"},
  {"id": "reject", "fromStates": ["review"], "toState": "rejected"},
  {"id": "revise", "fromStates": ["review"], "toState": "draft"}
]</textarea>
                        </div>
                    </div>

                    <button onclick="createWorkflow()" class="btn-success">
                        <span id="createLoading"></span>Create Workflow
                    </button>
                </div>

                <div id="templates-tab" class="tab-content">
                    <div class="form-section">
                        <h3>Predefined Templates</h3>
                        <div class="form-group">
                            <label for="templateSelect">Choose Template</label>
                            <select id="templateSelect" onchange="loadTemplate()">
                                <option value="">Select a template...</option>
                                <option value="approval">Document Approval</option>
                                <option value="order">Order Processing</option>
                                <option value="support">Support Ticket</option>
                                <option value="hiring">Hiring Process</option>
                            </select>
                        </div>
                        <button onclick="loadTemplate()" class="btn-primary">Load Template</button>
                    </div>
                </div>

                <div id="import-tab" class="tab-content">
                    <div class="form-section">
                        <h3>Import Workflow</h3>
                        <div class="form-group">
                            <label for="importJson">Paste Workflow JSON</label>
                            <textarea id="importJson" rows="8" placeholder="Paste complete workflow definition..."></textarea>
                        </div>
                        <button onclick="importWorkflow()" class="btn-primary">Import</button>
                    </div>
                    
                    <div class="form-section">
                        <h3>Export Current Workflow</h3>
                        <button onclick="exportWorkflow()" class="btn-warning">Export to JSON</button>
                    </div>
                </div>
            </div>

            <!-- Workflow Visualization Panel -->
            <div class="panel">
                <h2><span class="panel-icon">📊</span>Workflow Visualization</h2>
                <div id="workflowVisual" class="workflow-visual">
                    <div style="opacity: 0.6;">
                        <h3>🎯 No Workflow Loaded</h3>
                        <p>Create or load a workflow to see the visual representation</p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statesCount">0</div>
                        <div class="stat-label">States</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="actionsCount">0</div>
                        <div class="stat-label">Actions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="instancesCount">0</div>
                        <div class="stat-label">Instances</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="workflow-grid">
            <!-- Instance Management Panel -->
            <div class="panel">
                <h2><span class="panel-icon">⚡</span>Instance Management</h2>
                
                <div class="form-section">
                    <h3>Create New Instance</h3>
                    <div class="form-group">
                        <label for="instanceWorkflowId">Workflow ID</label>
                        <input type="text" id="instanceWorkflowId" placeholder="Enter workflow ID" value="demo-workflow">
                    </div>
                    <button onclick="startInstance()" class="btn-success">
                        <span id="startLoading"></span>Start Instance
                    </button>
                </div>

                <div class="form-section">
                    <h3>Active Instances</h3>
                    <div id="instancesList" class="instance-list">
                        <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                            No instances found. Start a workflow instance first.
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Bulk Operations</h3>
                    <button onclick="refreshInstances()" class="btn-primary">Refresh Instances</button>
                    <button onclick="clearAllInstances()" class="btn-danger">Clear All</button>
                </div>
            </div>

            <!-- Action Execution Panel -->
            <div class="panel">
                <h2><span class="panel-icon">🔄</span>Action Execution</h2>
                
                <div class="form-section">
                    <h3>Execute Action</h3>
                    <div class="form-group">
                        <label for="selectedInstanceId">Selected Instance</label>
                        <input type="text" id="selectedInstanceId" placeholder="Select an instance first" readonly>
                    </div>
                    <div class="form-group">
                        <label for="actionId">Action ID</label>
                        <select id="actionId">
                            <option value="">Select instance first...</option>
                        </select>
                    </div>
                    <button onclick="executeAction()" class="btn-warning" id="executeBtn" disabled>
                        <span id="executeLoading"></span>Execute Action
                    </button>
                </div>

                <div class="form-section">
                    <h3>Instance History</h3>
                    <div id="instanceHistory" class="history-timeline">
                        <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                            Select an instance to view its execution history.
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Testing Panel -->
            <div class="panel">
                <h2><span class="panel-icon">🧪</span>API Testing</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('manual-test')">Manual Test</button>
                    <button class="tab" onclick="showTab('automated-test')">Automated Test</button>
                    <button class="tab" onclick="showTab('load-test')">Load Test</button>
                </div>

                <div id="manual-test" class="tab-content active">
                    <div class="form-section">
                        <h3>Manual API Testing</h3>
                        <div class="form-group">
                            <label for="apiEndpoint">Endpoint</label>
                            <select id="apiEndpoint">
                                <option value="GET /instances/">GET Instance Status</option>
                                <option value="POST /workflows">POST Create Workflow</option>
                                <option value="POST /workflows/{id}/instances">POST Start Instance</option>
                                <option value="POST /instances/{id}/execute">POST Execute Action</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="testPayload">Request Payload (JSON)</label>
                            <textarea id="testPayload" rows="4" placeholder="Enter request body for POST requests..."></textarea>
                        </div>
                        <button onclick="executeApiTest()" class="btn-primary">Execute API Call</button>
                    </div>
                </div>

                <div id="automated-test" class="tab-content">
                    <div class="form-section">
                        <h3>Automated Test Scenarios</h3>
                        <button onclick="runFullWorkflowTest()" class="btn-success">Run Full Workflow Test</button>
                        <button onclick="runErrorHandlingTest()" class="btn-warning">Test Error Handling</button>
                        <button onclick="runValidationTest()" class="btn-danger">Test Validation Rules</button>
                    </div>
                </div>

                <div id="load-test" class="tab-content">
                    <div class="form-section">
                        <h3>Performance Load Testing</h3>
                        <div class="form-group">
                            <label for="concurrentRequests">Concurrent Requests</label>
                            <input type="number" id="concurrentRequests" value="10" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label for="testDuration">Duration (seconds)</label>
                            <input type="number" id="testDuration" value="30" min="5" max="300">
                        </div>
                        <button onclick="runLoadTest()" class="btn-danger">Start Load Test</button>
                    </div>
                </div>
            </div>

            <!-- Response Monitor Panel -->
            <div class="panel">
                <h2><span class="panel-icon">📡</span>Response Monitor</h2>
                
                <div class="form-section">
                    <h3>Latest API Response</h3>
                    <div id="responseArea" class="response-area">
Ready to display API responses...

Try creating a workflow or starting an instance to see the API responses here.
                    </div>
                </div>

                <div class="form-section">
                    <h3>Response Actions</h3>
                    <button onclick="clearResponse()" class="btn-primary">Clear</button>
                    <button onclick="copyResponse()" class="btn-success">Copy JSON</button>
                    <button onclick="formatResponse()" class="btn-warning">Format</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:5004';
        let currentWorkflow = null;
        let currentInstance = null;
        let workflowInstances = [];

        // Workflow Templates
        const templates = {
            approval: {
                id: 'document-approval',
                states: [
                    {"id": "draft", "isInitial": true, "isFinal": false},
                    {"id": "review", "isInitial": false, "isFinal": false},
                    {"id": "approved", "isInitial": false, "isFinal": true},
                    {"id": "rejected", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "submit", "fromStates": ["draft"], "toState": "review"},
                    {"id": "approve", "fromStates": ["review"], "toState": "approved"},
                    {"id": "reject", "fromStates": ["review"], "toState": "rejected"},
                    {"id": "revise", "fromStates": ["review"], "toState": "draft"}
                ]
            },
            order: {
                id: 'order-processing',
                states: [
                    {"id": "cart", "isInitial": true, "isFinal": false},
                    {"id": "checkout", "isInitial": false, "isFinal": false},
                    {"id": "payment", "isInitial": false, "isFinal": false},
                    {"id": "shipped", "isInitial": false, "isFinal": false},
                    {"id": "delivered", "isInitial": false, "isFinal": true},
                    {"id": "cancelled", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "checkout", "fromStates": ["cart"], "toState": "checkout"},
                    {"id": "pay", "fromStates": ["checkout"], "toState": "payment"},
                    {"id": "ship", "fromStates": ["payment"], "toState": "shipped"},
                    {"id": "deliver", "fromStates": ["shipped"], "toState": "delivered"},
                    {"id": "cancel", "fromStates": ["cart", "checkout"], "toState": "cancelled"}
                ]
            },
            support: {
                id: 'support-ticket',
                states: [
                    {"id": "open", "isInitial": true, "isFinal": false},
                    {"id": "assigned", "isInitial": false, "isFinal": false},
                    {"id": "in_progress", "isInitial": false, "isFinal": false},
                    {"id": "resolved", "isInitial": false, "isFinal": true},
                    {"id": "closed", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "assign", "fromStates": ["open"], "toState": "assigned"},
                    {"id": "start_work", "fromStates": ["assigned"], "toState": "in_progress"},
                    {"id": "resolve", "fromStates": ["in_progress"], "toState": "resolved"},
                    {"id": "close", "fromStates": ["resolved"], "toState": "closed"},
                    {"id": "reopen", "fromStates": ["resolved"], "toState": "assigned"}
                ]
            },
            hiring: {
                id: 'hiring-process',
                states: [
                    {"id": "applied", "isInitial": true, "isFinal": false},
                    {"id": "screening", "isInitial": false, "isFinal": false},
                    {"id": "interview", "isInitial": false, "isFinal": false},
                    {"id": "offer", "isInitial": false, "isFinal": false},
                    {"id": "hired", "isInitial": false, "isFinal": true},
                    {"id": "rejected", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "screen", "fromStates": ["applied"], "toState": "screening"},
                    {"id": "schedule_interview", "fromStates": ["screening"], "toState": "interview"},
                    {"id": "make_offer", "fromStates": ["interview"], "toState": "offer"},
                    {"id": "hire", "fromStates": ["offer"], "toState": "hired"},
                    {"id": "reject", "fromStates": ["screening", "interview", "offer"], "toState": "rejected"}
                ]
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkApiConnection();
            setInterval(checkApiConnection, 30000); // Check every 30 seconds
        });

        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            const loading = method === 'POST' ? showLoading() : null;
            
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                displayResponse(data, 'success');
                return data;

            } catch (error) {
                console.error('API Error:', error);
                displayResponse({ error: error.message }, 'error');
                showNotification(error.message, 'error');
                throw error;
            } finally {
                if (loading) hideLoading(loading);
            }
        }

        async function checkApiConnection() {
            const statusElement = document.getElementById('apiStatus');
            
            try {
                // Try to make a simple request to check if API is running
                const response = await fetch(`${API_BASE}/instances/test-connection-check`);
                // Even if we get 404, it means the API is running
                statusElement.className = 'api-status connected';
                statusElement.innerHTML = '<div class="status-dot"></div><span>API Connected</span>';
            } catch (error) {
                statusElement.className = 'api-status disconnected';
                statusElement.innerHTML = '<div class="status-dot"></div><span>API Disconnected</span>';
            }
        }

        // UI Helper Functions
        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            return loadingId;
        }

        function hideLoading(loadingId) {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(el => el.remove());
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function displayResponse(data, type = 'info') {
            const responseArea = document.getElementById('responseArea');
            responseArea.className = `response-area ${type}`;
            responseArea.textContent = JSON.stringify(data, null, 2);
        }

        // Workflow Management Functions
        async function createWorkflow() {
            const workflowId = document.getElementById('workflowId').value;
            const statesJson = document.getElementById('statesJson').value;
            const actionsJson = document.getElementById('actionsJson').value;

            if (!workflowId) {
                showNotification('Please enter a workflow ID', 'error');
                return;
            }

            try {
                const states = JSON.parse(statesJson);
                const actions = JSON.parse(actionsJson);

                const workflowData = {
                    id: workflowId,
                    states: states,
                    actions: actions
                };

                const result = await apiCall('/workflows', 'POST', workflowData);
                currentWorkflow = result;
                
                showNotification('Workflow created successfully!', 'success');
                visualizeWorkflow(result);
                updateStats();
                
                // Update instance workflow ID
                document.getElementById('instanceWorkflowId').value = workflowId;

            } catch (error) {
                if (error.message.includes('JSON')) {
                    showNotification('Invalid JSON in states or actions', 'error');
                }
            }
        }

        function loadTemplate() {
            const templateName = document.getElementById('templateSelect').value;
            if (!templateName) return;

            const template = templates[templateName];
            if (!template) return;

            document.getElementById('workflowId').value = template.id;
            document.getElementById('statesJson').value = JSON.stringify(template.states, null, 2);
            document.getElementById('actionsJson').value = JSON.stringify(template.actions, null, 2);
            
            showNotification(`Template "${templateName}" loaded`, 'success');
        }

        function importWorkflow() {
            const importJson = document.getElementById('importJson').value;
            if (!importJson) {
                showNotification('Please paste workflow JSON', 'error');
                return;
            }

            try {
                const workflow = JSON.parse(importJson);
                
                if (!workflow.id || !workflow.states || !workflow.actions) {
                    throw new Error('Invalid workflow format');
                }

                document.getElementById('workflowId').value = workflow.id;
                document.getElementById('statesJson').value = JSON.stringify(workflow.states, null, 2);
                document.getElementById('actionsJson').value = JSON.stringify(workflow.actions, null, 2);
                
                showNotification('Workflow imported successfully', 'success');
            } catch (error) {
                showNotification('Invalid workflow JSON', 'error');
            }
        }

        function exportWorkflow() {
            if (!currentWorkflow) {
                showNotification('No workflow to export', 'error');
                return;
            }

            const exportData = JSON.stringify(currentWorkflow, null, 2);
            navigator.clipboard.writeText(exportData).then(() => {
                showNotification('Workflow JSON copied to clipboard', 'success');
            });
        }

        function visualizeWorkflow(workflow) {
            const visualElement = document.getElementById('workflowVisual');
            
            if (!workflow || !workflow.states || !workflow.actions) {
                visualElement.innerHTML = `
                    <div style="opacity: 0.6;">
                        <h3>🎯 No Workflow Loaded</h3>
                        <p>Create or load a workflow to see the visual representation</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="workflow-graph">';
            
            // Sort states to show initial first, then others, then final
            const sortedStates = workflow.states.sort((a, b) => {
                if (a.isInitial) return -1;
                if (b.isInitial) return 1;
                if (a.isFinal && !b.isFinal) return 1;
                if (b.isFinal && !a.isFinal) return -1;
                return 0;
            });

            for (let i = 0; i < sortedStates.length; i++) {
                const state = sortedStates[i];
                let classes = 'state-node';
                if (state.isInitial) classes += ' initial';
                if (state.isFinal) classes += ' final';
                if (currentInstance && currentInstance.currentState === state.id) {
                    classes += ' current';
                }

                html += `<div class="${classes}">${state.id}</div>`;

                // Add action arrows between states
                if (i < sortedStates.length - 1) {
                    const nextState = sortedStates[i + 1];
                    const action = workflow.actions.find(a => 
                        a.fromStates.includes(state.id) && a.toState === nextState.id
                    );
                    
                    if (action) {
                        html += `
                            <div class="action-arrow">
                                <div class="arrow"></div>
                                <div class="action-label">${action.id}</div>
                            </div>
                        `;
                    }
                }
            }

            html += '</div>';
            visualElement.innerHTML = html;
        }

        function updateStats() {
            if (currentWorkflow) {
                document.getElementById('statesCount').textContent = currentWorkflow.states.length;
                document.getElementById('actionsCount').textContent = currentWorkflow.actions.length;
            }
            document.getElementById('instancesCount').textContent = workflowInstances.length;
        }

        // Instance Management Functions
        async function startInstance() {
            const workflowId = document.getElementById('instanceWorkflowId').value;
            if (!workflowId) {
                showNotification('Please enter a workflow ID', 'error');
                return;
            }

            try {
                const instance = await apiCall(`/workflows/${workflowId}/instances`, 'POST');
                workflowInstances.push(instance);
                
                showNotification('Instance started successfully!', 'success');
                refreshInstancesList();
                updateStats();
                
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        function refreshInstancesList() {
            const listElement = document.getElementById('instancesList');
            
            if (workflowInstances.length === 0) {
                listElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                        No instances found. Start a workflow instance first.
                    </div>
                `;
                return;
            }

            let html = '';
            workflowInstances.forEach(instance => {
                const isSelected = currentInstance && currentInstance.id === instance.id;
                html += `
                    <div class="instance-item ${isSelected ? 'selected' : ''}" onclick="selectInstance('${instance.id}')">
                        <div class="instance-info">
                            <div class="instance-id">${instance.id}</div>
                            <div class="instance-state">State: ${instance.currentState}</div>
                        </div>
                        <div class="instance-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); refreshInstance('${instance.id}')">Refresh</button>
                        </div>
                    </div>
                `;
            });

            listElement.innerHTML = html;
        }

        async function selectInstance(instanceId) {
            try {
                const instance = await apiCall(`/instances/${instanceId}`);
                currentInstance = instance;
                
                // Update UI
                document.getElementById('selectedInstanceId').value = instanceId;
                refreshInstancesList();
                updateInstanceHistory(instance);
                updateAvailableActions();
                
                // Update visualization to show current state
                if (currentWorkflow) {
                    visualizeWorkflow(currentWorkflow);
                }
                
                document.getElementById('executeBtn').disabled = false;
                
            } catch (error) {
                showNotification('Failed to load instance details', 'error');
            }
        }

        async function refreshInstance(instanceId) {
            try {
                const instance = await apiCall(`/instances/${instanceId}`);
                
                // Update the instance in our local array
                const index = workflowInstances.findIndex(i => i.id === instanceId);
                if (index !== -1) {
                    workflowInstances[index] = instance;
                }
                
                // If this is the currently selected instance, update it
                if (currentInstance && currentInstance.id === instanceId) {
                    currentInstance = instance;
                    updateInstanceHistory(instance);
                }
                
                refreshInstancesList();
                showNotification('Instance refreshed', 'success');
                
            } catch (error) {
                showNotification('Failed to refresh instance', 'error');
            }
        }

        function updateInstanceHistory(instance) {
            const historyElement = document.getElementById('instanceHistory');
            
            if (!instance.history || instance.history.length === 0) {
                historyElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                        No history available for this instance.
                    </div>
                `;
                return;
            }

            let html = '';
            instance.history.forEach(entry => {
                const timestamp = new Date(entry.timestamp).toLocaleString();
                html += `
                    <div class="history-item">
                        <div class="history-dot"></div>
                        <div class="history-content">
                            <div class="history-action">${entry.action}</div>
                            <div class="history-time">${timestamp}</div>
                        </div>
                    </div>
                `;
            });

            historyElement.innerHTML = html;
        }

        function updateAvailableActions() {
            const actionSelect = document.getElementById('actionId');
            actionSelect.innerHTML = '<option value="">Select an action...</option>';

            if (!currentWorkflow || !currentInstance) return;

            const currentState = currentInstance.currentState;
            const availableActions = currentWorkflow.actions.filter(action => 
                action.fromStates.includes(currentState)
            );

            availableActions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.id;
                option.textContent = `${action.id} → ${action.toState}`;
                actionSelect.appendChild(option);
            });
        }

        async function executeAction() {
            const instanceId = currentInstance?.id;
            const actionId = document.getElementById('actionId').value;

            if (!instanceId || !actionId) {
                showNotification('Please select instance and action', 'error');
                return;
            }

            try {
                const result = await apiCall(`/instances/${instanceId}/execute`, 'POST', {
                    actionId: actionId
                });

                currentInstance = result;
                
                // Update the instance in our local array
                const index = workflowInstances.findIndex(i => i.id === instanceId);
                if (index !== -1) {
                    workflowInstances[index] = result;
                }

                showNotification(`Action "${actionId}" executed successfully!`, 'success');
                updateInstanceHistory(result);
                updateAvailableActions();
                refreshInstancesList();
                
                // Update visualization to show new current state
                if (currentWorkflow) {
                    visualizeWorkflow(currentWorkflow);
                }

            } catch (error) {
                // Error already handled by apiCall
            }
        }

        function clearAllInstances() {
            if (confirm('Are you sure you want to clear all instances?')) {
                workflowInstances = [];
                currentInstance = null;
                refreshInstancesList();
                updateStats();
                document.getElementById('selectedInstanceId').value = '';
                document.getElementById('executeBtn').disabled = true;
                document.getElementById('instanceHistory').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                        Select an instance to view its execution history.
                    </div>
                `;
                showNotification('All instances cleared', 'info');
            }
        }

        function refreshInstances() {
            refreshInstancesList();
            showNotification('Instance list refreshed', 'info');
        }

        // Testing Functions
        async function executeApiTest() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const payload = document.getElementById('testPayload').value;

            try {
                let method, url, body = null;

                if (endpoint.startsWith('GET')) {
                    method = 'GET';
                    url = endpoint.replace('GET ', '');
                    if (url.includes('{')) {
                        const instanceId = prompt('Enter instance ID:');
                        if (!instanceId) return;
                        url = url.replace('{id}', instanceId);
                    }
                } else if (endpoint.startsWith('POST')) {
                    method = 'POST';
                    url = endpoint.replace('POST ', '');
                    if (url.includes('{')) {
                        const id = prompt('Enter ID:');
                        if (!id) return;
                        url = url.replace('{id}', id);
                    }
                    if (payload) {
                        body = JSON.parse(payload);
                    }
                }

                await apiCall(url, method, body);
                showNotification('API test executed successfully', 'success');

            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function runFullWorkflowTest() {
            showNotification('Starting full workflow test...', 'info');
            
            try {
                // 1. Create workflow
                const workflow = {
                    id: 'test-workflow-' + Date.now(),
                    states: [
                        {"id": "start", "isInitial": true, "isFinal": false},
                        {"id": "middle", "isInitial": false, "isFinal": false},
                        {"id": "end", "isInitial": false, "isFinal": true}
                    ],
                    actions: [
                        {"id": "proceed", "fromStates": ["start"], "toState": "middle"},
                        {"id": "finish", "fromStates": ["middle"], "toState": "end"}
                    ]
                };
                
                await apiCall('/workflows', 'POST', workflow);
                
                // 2. Start instance
                const instance = await apiCall(`/workflows/${workflow.id}/instances`, 'POST');
                
                // 3. Execute actions
                await apiCall(`/instances/${instance.id}/execute`, 'POST', {actionId: 'proceed'});
                await apiCall(`/instances/${instance.id}/execute`, 'POST', {actionId: 'finish'});
                
                // 4. Get final status
                const finalInstance = await apiCall(`/instances/${instance.id}`);
                
                showNotification('Full workflow test completed successfully!', 'success');
                displayResponse({
                    testResult: 'SUCCESS',
                    workflow: workflow,
                    finalInstance: finalInstance
                }, 'success');

            } catch (error) {
                showNotification('Full workflow test failed', 'error');
            }
        }

        async function runErrorHandlingTest() {
            showNotification('Testing error handling...', 'info');
            
            const tests = [
                { description: 'Invalid workflow ID', test: () => apiCall('/workflows/nonexistent/instances', 'POST') },
                { description: 'Invalid instance ID', test: () => apiCall('/instances/nonexistent') },
                { description: 'Invalid action', test: () => apiCall('/instances/test/execute', 'POST', {actionId: 'invalid'}) }
            ];

            let results = [];
            
            for (const test of tests) {
                try {
                    await test.test();
                    results.push({ description: test.description, result: 'UNEXPECTED_SUCCESS' });
                } catch (error) {
                    results.push({ description: test.description, result: 'EXPECTED_ERROR', error: error.message });
                }
            }

            displayResponse({ errorHandlingTests: results }, 'info');
            showNotification('Error handling tests completed', 'success');
        }

        async function runValidationTest() {
            showNotification('Testing validation rules...', 'info');
            
            const invalidWorkflows = [
                {
                    description: 'No initial state',
                    workflow: {
                        id: 'test-no-initial',
                        states: [{"id": "state1", "isInitial": false, "isFinal": false}],
                        actions: []
                    }
                },
                {
                    description: 'Multiple initial states',
                    workflow: {
                        id: 'test-multiple-initial',
                        states: [
                            {"id": "state1", "isInitial": true, "isFinal": false},
                            {"id": "state2", "isInitial": true, "isFinal": false}
                        ],
                        actions: []
                    }
                }
            ];

            let results = [];
            
            for (const test of invalidWorkflows) {
                try {
                    await apiCall('/workflows', 'POST', test.workflow);
                    results.push({ description: test.description, result: 'UNEXPECTED_SUCCESS' });
                } catch (error) {
                    results.push({ description: test.description, result: 'EXPECTED_VALIDATION_ERROR', error: error.message });
                }
            }

            displayResponse({ validationTests: results }, 'info');
            showNotification('Validation tests completed', 'success');
        }

        async function runLoadTest() {
            const concurrentRequests = parseInt(document.getElementById('concurrentRequests').value);
            const duration = parseInt(document.getElementById('testDuration').value);
            
            showNotification(`Starting load test: ${concurrentRequests} concurrent requests for ${duration} seconds`, 'info');
            
            const startTime = Date.now();
            const endTime = startTime + (duration * 1000);
            let requestCount = 0;
            let successCount = 0;
            let errorCount = 0;
            
            const promises = [];
            
            // Create a simple workflow for testing
            const testWorkflow = {
                id: 'load-test-' + Date.now(),
                states: [
                    {"id": "start", "isInitial": true, "isFinal": false},
                    {"id": "end", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "finish", "fromStates": ["start"], "toState": "end"}
                ]
            };
            
            try {
                await apiCall('/workflows', 'POST', testWorkflow);
                
                for (let i = 0; i < concurrentRequests; i++) {
                    promises.push(loadTestWorker(testWorkflow.id, endTime, (success, error) => {
                        requestCount++;
                        if (success) successCount++;
                        if (error) errorCount++;
                    }));
                }
                
                await Promise.all(promises);
                
                const totalTime = Date.now() - startTime;
                const rps = (requestCount / (totalTime / 1000)).toFixed(2);
                
                const results = {
                    duration: totalTime / 1000,
                    totalRequests: requestCount,
                    successfulRequests: successCount,
                    failedRequests: errorCount,
                    requestsPerSecond: rps,
                    successRate: ((successCount / requestCount) * 100).toFixed(2) + '%'
                };
                
                displayResponse({ loadTestResults: results }, 'success');
                showNotification('Load test completed', 'success');
                
            } catch (error) {
                showNotification('Load test failed to start', 'error');
            }
        }

        async function loadTestWorker(workflowId, endTime, callback) {
            while (Date.now() < endTime) {
                try {
                    await fetch(`${API_BASE}/workflows/${workflowId}/instances`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    callback(true, false);
                } catch (error) {
                    callback(false, true);
                }
                
                // Small delay to prevent overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 10));
            }
        }

        // Response Management Functions
        function clearResponse() {
            document.getElementById('responseArea').textContent = 'Response cleared.';
            document.getElementById('responseArea').className = 'response-area';
        }

        function copyResponse() {
            const responseText = document.getElementById('responseArea').textContent;
            navigator.clipboard.writeText(responseText).then(() => {
                showNotification('Response copied to clipboard', 'success');
            });
        }

        function formatResponse() {
            const responseArea = document.getElementById('responseArea');
            try {
                const data = JSON.parse(responseArea.textContent);
                responseArea.textContent = JSON.stringify(data, null, 2);
                showNotification('Response formatted', 'success');
            } catch (error) {
                showNotification('Invalid JSON - cannot format', 'error');
            }
        }
    </script>
</body>
</html>
