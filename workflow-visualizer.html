<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Engine Visualizer & Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, textarea, select, button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .workflow-visual {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ddd;
            min-height: 300px;
        }

        .state {
            display: inline-block;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 50px;
            padding: 15px 25px;
            margin: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .state.initial {
            background: #d5f4e6;
            border-color: #27ae60;
            color: #27ae60;
        }

        .state.final {
            background: #fadbd8;
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .state.current {
            background: #d6eaf8;
            border-color: #3498db;
            color: #3498db;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
            transform: scale(1.1);
        }

        .action-arrow {
            display: inline-block;
            margin: 0 15px;
            color: #7f8c8d;
            font-weight: bold;
            position: relative;
        }

        .action-arrow::after {
            content: '‚Üí';
            font-size: 24px;
        }

        .action-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }

        .status-panel {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .status-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }

        .history-item .action {
            font-weight: 600;
            color: #2c3e50;
        }

        .history-item .timestamp {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .error {
            background: #fadbd8;
            border: 1px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #229954;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .json-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Workflow Engine Visualizer</h1>
            <p>Interactive testing and visualization tool for the Configurable Workflow Engine</p>
        </div>

        <div class="main-content">
            <!-- Left Panel: Workflow Creation -->
            <div class="panel">
                <h2>üèóÔ∏è Create Workflow</h2>
                
                <div class="form-group">
                    <label for="workflowId">Workflow ID:</label>
                    <input type="text" id="workflowId" placeholder="e.g., order-workflow" value="sample-workflow">
                </div>

                <div class="form-group">
                    <label for="statesConfig">States Configuration (JSON):</label>
                    <textarea id="statesConfig" rows="8" placeholder="Define your states...">
[
  {"id": "draft", "isInitial": true, "isFinal": false},
  {"id": "review", "isInitial": false, "isFinal": false},
  {"id": "approved", "isInitial": false, "isFinal": true},
  {"id": "rejected", "isInitial": false, "isFinal": true}
]</textarea>
                </div>

                <div class="form-group">
                    <label for="actionsConfig">Actions Configuration (JSON):</label>
                    <textarea id="actionsConfig" rows="8" placeholder="Define your actions...">
[
  {"id": "submit", "fromStates": ["draft"], "toState": "review"},
  {"id": "approve", "fromStates": ["review"], "toState": "approved"},
  {"id": "reject", "fromStates": ["review"], "toState": "rejected"},
  {"id": "revise", "fromStates": ["review"], "toState": "draft"}
]</textarea>
                </div>

                <div class="button-group">
                    <button onclick="createWorkflow()" class="btn-success">Create Workflow</button>
                    <button onclick="loadPreset('orderWorkflow')" class="btn-warning">Load Order Preset</button>
                    <button onclick="loadPreset('approvalWorkflow')" class="btn-warning">Load Approval Preset</button>
                    <button onclick="clearAll()" class="btn-danger">Clear All</button>
                </div>

                <div id="createResult"></div>
            </div>

            <!-- Right Panel: Workflow Testing -->
            <div class="panel">
                <h2>üß™ Test Workflow</h2>
                
                <div class="form-group">
                    <label for="definitionSelect">Select Workflow:</label>
                    <select id="definitionSelect">
                        <option value="">-- Select a workflow --</option>
                    </select>
                </div>

                <div class="button-group">
                    <button onclick="startInstance()" class="btn-success">Start New Instance</button>
                    <button onclick="getInstanceStatus()" class="btn-warning">Refresh Status</button>
                </div>

                <div class="form-group" id="actionControls" style="display: none;">
                    <label for="actionSelect">Execute Action:</label>
                    <select id="actionSelect">
                        <option value="">-- Select an action --</option>
                    </select>
                    <button onclick="executeAction()" class="btn-success" style="margin-top: 10px;">Execute Action</button>
                </div>

                <div id="testResult"></div>
            </div>
        </div>

        <!-- Full Width: Workflow Visualization -->
        <div class="panel" style="margin: 0 30px 30px 30px;">
            <h2>üìä Workflow Visualization</h2>
            <div id="workflowVisual" class="workflow-visual">
                <p style="text-align: center; color: #7f8c8d; padding: 50px;">Create a workflow to see the visualization</p>
            </div>
        </div>

        <!-- Full Width: Instance Status -->
        <div class="panel" style="margin: 0 30px 30px 30px;" id="instancePanel" style="display: none;">
            <h2>üìã Instance Status</h2>
            <div id="instanceStatus" class="status-panel">
                <p style="text-align: center; color: #7f8c8d;">Start an instance to see the status</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5004';
        let currentDefinition = null;
        let currentInstance = null;
        let workflows = {};

        // Presets
        const presets = {
            orderWorkflow: {
                id: 'order-workflow',
                states: [
                    {"id": "cart", "isInitial": true, "isFinal": false},
                    {"id": "checkout", "isInitial": false, "isFinal": false},
                    {"id": "payment", "isInitial": false, "isFinal": false},
                    {"id": "shipped", "isInitial": false, "isFinal": false},
                    {"id": "delivered", "isInitial": false, "isFinal": true},
                    {"id": "cancelled", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "checkout", "fromStates": ["cart"], "toState": "checkout"},
                    {"id": "pay", "fromStates": ["checkout"], "toState": "payment"},
                    {"id": "ship", "fromStates": ["payment"], "toState": "shipped"},
                    {"id": "deliver", "fromStates": ["shipped"], "toState": "delivered"},
                    {"id": "cancel", "fromStates": ["cart", "checkout"], "toState": "cancelled"}
                ]
            },
            approvalWorkflow: {
                id: 'approval-workflow',
                states: [
                    {"id": "draft", "isInitial": true, "isFinal": false},
                    {"id": "pending", "isInitial": false, "isFinal": false},
                    {"id": "manager_review", "isInitial": false, "isFinal": false},
                    {"id": "approved", "isInitial": false, "isFinal": true},
                    {"id": "rejected", "isInitial": false, "isFinal": true}
                ],
                actions: [
                    {"id": "submit", "fromStates": ["draft"], "toState": "pending"},
                    {"id": "escalate", "fromStates": ["pending"], "toState": "manager_review"},
                    {"id": "approve", "fromStates": ["pending", "manager_review"], "toState": "approved"},
                    {"id": "reject", "fromStates": ["pending", "manager_review"], "toState": "rejected"},
                    {"id": "revise", "fromStates": ["pending", "manager_review"], "toState": "draft"}
                ]
            }
        };

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function showJsonResult(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            const titleHtml = title ? `<h3>${title}</h3>` : '';
            element.innerHTML = `
                ${titleHtml}
                <div class="json-display">${JSON.stringify(data, null, 2)}</div>
            `;
        }

        function loadPreset(presetName) {
            const preset = presets[presetName];
            document.getElementById('workflowId').value = preset.id;
            document.getElementById('statesConfig').value = JSON.stringify(preset.states, null, 2);
            document.getElementById('actionsConfig').value = JSON.stringify(preset.actions, null, 2);
        }

        async function createWorkflow() {
            try {
                const workflowId = document.getElementById('workflowId').value.trim();
                const statesText = document.getElementById('statesConfig').value.trim();
                const actionsText = document.getElementById('actionsConfig').value.trim();

                if (!workflowId || !statesText || !actionsText) {
                    throw new Error('Please fill in all fields');
                }

                const states = JSON.parse(statesText);
                const actions = JSON.parse(actionsText);

                const request = {
                    id: workflowId,
                    states: states,
                    actions: actions
                };

                const result = await apiCall('/workflows', 'POST', request);
                
                workflows[workflowId] = result;
                currentDefinition = result;
                
                updateDefinitionSelect();
                visualizeWorkflow(result);
                showJsonResult('createResult', result, '‚úÖ Workflow Created Successfully');

            } catch (error) {
                showResult('createResult', `‚ùå Error: ${error.message}`, true);
            }
        }

        function updateDefinitionSelect() {
            const select = document.getElementById('definitionSelect');
            select.innerHTML = '<option value="">-- Select a workflow --</option>';
            
            Object.keys(workflows).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = id;
                select.appendChild(option);
            });
        }

        async function startInstance() {
            try {
                const definitionId = document.getElementById('definitionSelect').value;
                if (!definitionId) {
                    throw new Error('Please select a workflow first');
                }

                const result = await apiCall(`/workflows/${definitionId}/instances`, 'POST');
                currentInstance = result;
                
                updateActionSelect();
                updateInstanceStatus();
                visualizeWorkflow(currentDefinition, currentInstance);
                
                document.getElementById('actionControls').style.display = 'block';
                document.getElementById('instancePanel').style.display = 'block';
                
                showJsonResult('testResult', result, '‚úÖ Instance Started Successfully');

            } catch (error) {
                showResult('testResult', `‚ùå Error: ${error.message}`, true);
            }
        }

        async function executeAction() {
            try {
                const actionId = document.getElementById('actionSelect').value;
                if (!actionId) {
                    throw new Error('Please select an action');
                }

                const request = { actionId: actionId };
                const result = await apiCall(`/instances/${currentInstance.id}/execute`, 'POST', request);
                
                currentInstance = result;
                updateInstanceStatus();
                visualizeWorkflow(currentDefinition, currentInstance);
                
                showJsonResult('testResult', result, '‚úÖ Action Executed Successfully');

            } catch (error) {
                showResult('testResult', `‚ùå Error: ${error.message}`, true);
            }
        }

        async function getInstanceStatus() {
            try {
                if (!currentInstance) {
                    throw new Error('No active instance');
                }

                const result = await apiCall(`/instances/${currentInstance.id}`);
                currentInstance = result;
                
                updateInstanceStatus();
                visualizeWorkflow(currentDefinition, currentInstance);
                
                showJsonResult('testResult', result, '‚úÖ Status Retrieved Successfully');

            } catch (error) {
                showResult('testResult', `‚ùå Error: ${error.message}`, true);
            }
        }

        function updateActionSelect() {
            const select = document.getElementById('actionSelect');
            select.innerHTML = '<option value="">-- Select an action --</option>';
            
            if (currentDefinition && currentInstance) {
                const currentState = currentInstance.currentState;
                const availableActions = currentDefinition.actions.filter(action => 
                    action.fromStates.includes(currentState)
                );
                
                availableActions.forEach(action => {
                    const option = document.createElement('option');
                    option.value = action.id;
                    option.textContent = `${action.id} (${currentState} ‚Üí ${action.toState})`;
                    select.appendChild(option);
                });
            }
        }

        function updateInstanceStatus() {
            if (!currentInstance) return;

            const statusHtml = `
                <div class="status-item">
                    <span><strong>Instance ID:</strong></span>
                    <span>${currentInstance.id}</span>
                </div>
                <div class="status-item">
                    <span><strong>Definition ID:</strong></span>
                    <span>${currentInstance.definitionId}</span>
                </div>
                <div class="status-item">
                    <span><strong>Current State:</strong></span>
                    <span><span class="state current">${currentInstance.currentState}</span></span>
                </div>
                <div style="margin-top: 20px;">
                    <h4>History:</h4>
                    ${currentInstance.history.map(entry => `
                        <div class="history-item">
                            <div class="action">${entry.action}</div>
                            <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('instanceStatus').innerHTML = statusHtml;
        }

        function visualizeWorkflow(definition, instance = null) {
            if (!definition) return;

            const currentState = instance ? instance.currentState : null;
            
            let html = '<div style="text-align: center;">';
            
            // Create a visual flow
            const states = definition.states;
            const actions = definition.actions;
            
            // Group states by their position in the flow
            const stateMap = new Map();
            states.forEach(state => stateMap.set(state.id, state));
            
            // Start with initial state
            const initialState = states.find(s => s.isInitial);
            if (initialState) {
                html += renderState(initialState, currentState);
                
                // Find actions from initial state
                const fromInitial = actions.filter(a => a.fromStates.includes(initialState.id));
                
                fromInitial.forEach(action => {
                    html += renderAction(action);
                    const toState = stateMap.get(action.toState);
                    if (toState) {
                        html += renderState(toState, currentState);
                    }
                });
            }
            
            html += '</div>';
            
            // Add actions summary
            html += '<div style="margin-top: 30px;"><h4>Available Actions:</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; margin-top: 15px;">';
            
            actions.forEach(action => {
                const fromStates = action.fromStates.join(', ');
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 3px solid #3498db;">
                        <strong>${action.id}</strong><br>
                        <small>${fromStates} ‚Üí ${action.toState}</small>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            document.getElementById('workflowVisual').innerHTML = html;
        }

        function renderState(state, currentState) {
            let className = 'state';
            if (state.isInitial) className += ' initial';
            if (state.isFinal) className += ' final';
            if (currentState === state.id) className += ' current';
            
            const label = state.isInitial ? 'üèÅ ' : state.isFinal ? 'üèÜ ' : '';
            return `<span class="${className}">${label}${state.id}</span>`;
        }

        function renderAction(action) {
            return `<span class="action-arrow"><span class="action-label">${action.id}</span></span>`;
        }

        function clearAll() {
            document.getElementById('workflowId').value = '';
            document.getElementById('statesConfig').value = '';
            document.getElementById('actionsConfig').value = '';
            document.getElementById('createResult').innerHTML = '';
            document.getElementById('testResult').innerHTML = '';
            document.getElementById('workflowVisual').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 50px;">Create a workflow to see the visualization</p>';
            document.getElementById('instanceStatus').innerHTML = '<p style="text-align: center; color: #7f8c8d;">Start an instance to see the status</p>';
            document.getElementById('actionControls').style.display = 'none';
            document.getElementById('instancePanel').style.display = 'none';
            
            workflows = {};
            currentDefinition = null;
            currentInstance = null;
            updateDefinitionSelect();
        }

        // Handle definition selection change
        document.getElementById('definitionSelect').addEventListener('change', function() {
            const selectedId = this.value;
            if (selectedId && workflows[selectedId]) {
                currentDefinition = workflows[selectedId];
                visualizeWorkflow(currentDefinition);
                currentInstance = null;
                document.getElementById('actionControls').style.display = 'none';
                document.getElementById('instancePanel').style.display = 'none';
            }
        });

        // Check if API is running on page load
        window.addEventListener('load', async function() {
            try {
                await fetch(`${API_BASE}/instances/test-connection`);
            } catch (error) {
                showResult('createResult', '‚ö†Ô∏è Warning: API server not running. Please start the API server with "dotnet run" in the Api project.', true);
            }
        });
    </script>
</body>
</html>
